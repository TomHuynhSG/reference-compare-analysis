{% extends 'base.html' %}

{% block content %}
<div class="mb-2 flex justify-between items-center">
    <h2>Search Results: <span style="color: var(--color-primary)">{{ filename }}</span></h2>
    <a href="/" class="btn btn-light">‚Üê Back</a>
</div>

<!-- Search Statistics -->
<div class="grid" style="grid-template-columns: repeat(3, 1fr);">
    <div class="card text-center" style="border-top: 4px solid var(--color-accent)">
        <h4 style="color: var(--color-accent)">Matched References</h4>
        <h1 style="margin: 0;">{{ stats.matched_count }}</h1>
        <small style="color: var(--color-text-muted)">{{ stats.match_percentage }}% of {{ stats.total_refs }} total</small>
        <div class="mt-1">
            <a href="{{ url_for('export_search', subset='matched', query=query, fields=','.join(fields)) }}"
                class="btn btn-light">
                ‚¨á Export RIS
            </a>
        </div>
    </div>
    <div class="card text-center" style="border-top: 4px solid var(--color-text-muted)">
        <h4 style="color: var(--color-text-muted)">Unmatched References</h4>
        <h1 style="margin: 0;">{{ stats.unmatched_count }}</h1>
        <small style="color: var(--color-text-muted)">{{ (100 - stats.match_percentage)|round(1) }}% not matched</small>
        <div class="mt-1">
            <a href="{{ url_for('export_search', subset='unmatched', query=query, fields=','.join(fields)) }}"
                class="btn btn-light">
                ‚¨á Export RIS
            </a>
        </div>
    </div>
    <div class="card text-center" style="border-top: 4px solid var(--color-primary)">
        <h4 style="color: var(--color-primary)">Search Fields</h4>
        <div style="margin-top: 0.5rem;">
            {% for field in fields %}
            <span style="background: var(--color-primary); color: white; padding: 4px 12px; border-radius: 12px; font-size: 14px; margin: 2px;">
                {{ field|capitalize }}
            </span>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Re-query Form -->
<div class="card mt-2">
    <h3>üîç Refine Your Search</h3>
    <p style="color: var(--color-text-muted); margin-bottom: 1rem;">
        Modify your query below to see different results without re-uploading the file.
    </p>
    <form action="/search/requery" method="post">
        <label for="query">Search Query</label>
        <textarea 
            id="query" 
            name="query" 
            rows="4" 
            required
            placeholder='Example: ("LLM*" OR "GPT*") AND "risk assessment"'
            style="font-family: 'Courier New', monospace; font-size: 14px;">{{ query }}</textarea>
        
        <label>Search in:</label>
        <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="fields" value="title" {% if 'title' in fields %}checked{% endif %}>
                <span>Title</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="fields" value="abstract" {% if 'abstract' in fields %}checked{% endif %}>
                <span>Abstract</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="fields" value="keywords" {% if 'keywords' in fields %}checked{% endif %}>
                <span>Keywords</span>
            </label>
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">üîÑ Re-run Search</button>
    </form>
</div>

{% if stats.error %}
<!-- Error Display -->
<div class="card mt-2" style="border-left: 4px solid #ff4444; background: rgba(255, 68, 68, 0.1);">
    <h3 style="color: #ff4444;">‚ùå Query Error</h3>
    <p style="color: var(--color-text);">{{ stats.error }}</p>
    <small style="color: var(--color-text-muted);">
        Please check your query syntax and try again.
    </small>
</div>
{% endif %}

<!-- Matched References Table -->
<div class="card mt-2">
    <h3 style="color: var(--color-accent)">‚úÖ Matched References ({{ stats.matched_count }})</h3>
    {% if stats.matched_count > 0 %}
    <div class="table-container" style="max-height: 600px; overflow-y: auto;">
        <table id="matchedTable">
            <thead>
                <tr>
                    <th style="width: 40px;">#</th>
                    <th onclick="sortTable(1, 'matchedTable')" style="cursor: pointer; width: 25%;">Title ‚áÖ</th>
                    <th onclick="sortTable(2, 'matchedTable')" style="cursor: pointer; width: 50%;">Abstract ‚áÖ</th>
                    <th onclick="sortTable(3, 'matchedTable')" style="cursor: pointer; width: 80px;">Year ‚áÖ</th>
                    <th onclick="sortTable(4, 'matchedTable')" style="cursor: pointer; width: 150px;">Authors ‚áÖ</th>
                    <th onclick="sortTable(5, 'matchedTable')" style="cursor: pointer; width: 100px;">Matched Occurrences ‚áÖ</th>
                </tr>
            </thead>
            <tbody>
                {% for row in matched_refs %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        {% if row.get('title_highlighted') %}
                            {{ row.title_highlighted|safe }}
                        {% elif row.get('ti_highlighted') %}
                            {{ row.ti_highlighted|safe }}
                        {% else %}
                            {{ row.get('title', row.get('ti', 'N/A')) }}
                        {% endif %}
                    </td>
                    <td style="font-size: 0.9rem; line-height: 1.6; word-wrap: break-word;">
                        {% set abstract = row.get('abstract') or row.get('ab') or row.get('n2') %}
                        {% set abstract_highlighted = row.get('abstract_highlighted') or row.get('ab_highlighted') or row.get('n2_highlighted') %}
                        {% if abstract_highlighted %}
                            <div style="word-wrap: break-word; overflow-wrap: break-word;">{{ abstract_highlighted|safe }}</div>
                        {% elif abstract %}
                            <div style="word-wrap: break-word; overflow-wrap: break-word; color: var(--color-text-muted);">{{ abstract }}</div>
                        {% else %}
                            <span style="color: var(--color-text-muted); font-size: 0.8rem;">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ row.get('year', row.get('py', 'N/A')) }}</td>
                    <td>
                        {% set authors = row.get('authors', row.get('au', [])) %}
                        {% if authors is sequence and authors is not string %}
                            {{ authors[:2]|join(', ') }}{% if authors|length > 2 %}...{% endif %}
                        {% else %}
                            {{ authors }}
                        {% endif %}
                    </td>
                    <td>
                        {% set matched_list = row.get('matched_terms', []) %}
                        <span 
                            style="background: var(--color-accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; cursor: help;" 
                            title="{{ matched_list|join(', ') if matched_list else 'No matches' }}">
                            {{ row.get('match_count', 0) }}
                        </span>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p style="color: var(--color-text-muted); text-align: center; padding: 2rem;">
        No references matched your search query.
    </p>
    {% endif %}
</div>

<!-- Unmatched References Table (Collapsible) -->
<div class="card mt-2">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3 style="color: var(--color-text-muted); margin: 0;">üìã Unmatched References ({{ stats.unmatched_count }})</h3>
        <button class="btn btn-light" onclick="toggleUnmatched()" id="toggleBtn">
            Show Unmatched
        </button>
    </div>
    
    <div id="unmatchedSection" style="display: none; margin-top: 1rem;">
        {% if stats.unmatched_count > 0 %}
        <div class="table-container" style="max-height: 400px; overflow-y: auto;">
            <table id="unmatchedTable">
                <thead>
                    <tr>
                        <th style="width: 40px;">#</th>
                        <th onclick="sortTable(1, 'unmatchedTable')" style="cursor: pointer; width: 25%;">Title ‚áÖ</th>
                        <th onclick="sortTable(2, 'unmatchedTable')" style="cursor: pointer; width: 50%;">Abstract ‚áÖ</th>
                        <th onclick="sortTable(3, 'unmatchedTable')" style="cursor: pointer; width: 80px;">Year ‚áÖ</th>
                        <th onclick="sortTable(4, 'unmatchedTable')" style="cursor: pointer; width: 150px;">Authors ‚áÖ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for row in unmatched_refs %}
                    <tr>
                        <td>{{ loop.index }}</td>
                        <td>{{ row.get('title', row.get('ti', 'N/A')) }}</td>
                        <td style="font-size: 0.9rem; line-height: 1.6; word-wrap: break-word;">
                            {% set abstract = row.get('abstract') or row.get('ab') or row.get('n2') %}
                            {% if abstract %}
                                <div style="word-wrap: break-word; overflow-wrap: break-word; color: var(--color-text-muted);">{{ abstract }}</div>
                            {% else %}
                                <span style="color: var(--color-text-muted); font-size: 0.8rem;">N/A</span>
                            {% endif %}
                        </td>
                        <td>{{ row.get('year', row.get('py', 'N/A')) }}</td>
                        <td>
                            {% set authors = row.get('authors', row.get('au', [])) %}
                            {% if authors is sequence and authors is not string %}
                                {{ authors[:2]|join(', ') }}{% if authors|length > 2 %}...{% endif %}
                            {% else %}
                                {{ authors }}
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="color: var(--color-text-muted); text-align: center; padding: 2rem;">
            All references matched your query!
        </p>
        {% endif %}
    </div>
</div>

<script>
function toggleUnmatched() {
    const section = document.getElementById('unmatchedSection');
    const btn = document.getElementById('toggleBtn');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        btn.textContent = 'Hide Unmatched';
    } else {
        section.style.display = 'none';
        btn.textContent = 'Show Unmatched';
    }
}

// Override openModal to handle HTML content (highlighted text)
function openModal(content, isHtml = false) {
    const modal = document.getElementById('modal');
    const modalText = document.getElementById('modal-text');
    
    if (isHtml) {
        modalText.innerHTML = content;
    } else {
        modalText.textContent = content;
    }
    
    modal.style.display = 'flex';
}
</script>

<style>
/* Highlight styling */
mark {
    background-color: #ffeb3b;
    color: #000;
    padding: 2px 4px;
    border-radius: 2px;
    font-weight: 500;
}

/* Table cell alignment - align to top */
table td {
    vertical-align: top;
}

/* Improve checkbox styling */
input[type="checkbox"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

/* Textarea styling */
textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid var(--color-border);
    border-radius: 8px;
    background: var(--color-bg-secondary);
    color: var(--color-text);
    resize: vertical;
    transition: border-color 0.3s;
}

textarea:focus {
    outline: none;
    border-color: var(--color-primary);
}
</style>

{% endblock %}
