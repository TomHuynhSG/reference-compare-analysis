{% extends 'base.html' %}

{% block content %}
<div class="text-center mb-2">
    <h2>üîÑ Deduplication Results</h2>
    <p style="color: var(--color-text-muted);">
        Removed duplicates across {{ stats.num_files }} files
    </p>
</div>

<!-- Statistics Cards -->
<div class="grid grid-3 mb-2">
    <div class="card text-center">
        <h4 style="color: var(--color-primary); margin: 0;">{{ stats.total_original }}</h4>
        <p style="color: var(--color-text-muted); margin: 0.5rem 0 0 0;">Total References</p>
    </div>
    <div class="card text-center"
        style="background: linear-gradient(135deg, rgba(var(--color-primary-rgb), 0.1), rgba(var(--color-primary-rgb), 0.05));">
        <h4 style="color: var(--color-success); margin: 0;">{{ stats.total_unique }}</h4>
        <p style="color: var(--color-text-muted); margin: 0.5rem 0 0 0;">Unique References</p>
    </div>
    <div class="card text-center">
        <h4 style="color: var(--color-danger); margin: 0;">{{ stats.total_duplicates }}</h4>
        <p style="color: var(--color-text-muted); margin: 0.5rem 0 0 0;">
            Duplicates Removed ({{ "%.1f"|format(stats.reduction_percent) }}%)
        </p>
    </div>
</div>

<!-- File Breakdown -->
<div class="card mb-2">
    <h3>üìÅ File Breakdown</h3>
    <div class="grid grid-2 gap-1">
        {% for filename, count in stats.file_counts.items() %}
        <div style="padding: 0.75rem; background: rgba(var(--color-primary-rgb), 0.05); border-radius: 8px;">
            <strong>{{ filename }}</strong>
            <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 0.25rem;">
                {{ count }} references
                {% if filename in stats.duplicates_by_file %}
                ({{ stats.duplicates_by_file[filename] }} duplicates removed)
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Unique References Table -->
<div class="card mb-2">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">‚úÖ Unique References ({{ stats.total_unique }})</h3>
        <form action="/export_dedup/unique" method="post" style="margin: 0;">
            {% for filename in filenames %}
            <input type="hidden" name="filenames" value="{{ filename }}">
            {% endfor %}
            <button type="submit" class="btn btn-primary">
                üì• Export as RIS
            </button>
        </form>
    </div>

    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th>Title</th>
                    <th style="width: 80px;">Year</th>
                    <th style="width: 120px;">Type</th>
                    <th style="width: 200px;">Source Files</th>
                    <th style="width: 100px;">Occurrences</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in unique_refs %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>
                        <strong>{{ ref.title or ref.ti or 'No Title' }}</strong>
                        {% set authors = ref.authors or ref.au %}
                        {% if authors is string %}
                        <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 0.25rem;">
                            {{ authors }}
                        </div>
                        {% elif authors is iterable %}
                        <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 0.25rem;">
                            {{ authors[0] }}{% if authors|length > 1 %} et al.{% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td>{{ ref.year or ref.py or 'N/A' }}</td>
                    <td>
                        <span class="badge">{{ ref.reference_type or ref.ty or 'JOUR' }}</span>
                    </td>
                    <td style="font-size: 13px;">
                        {% for source in ref.appears_in %}
                        <div
                            style="padding: 2px 6px; background: rgba(var(--color-primary-rgb), 0.1); border-radius: 4px; margin: 2px 0; display: inline-block;">
                            {{ source }}
                        </div>
                        {% endfor %}
                    </td>
                    <td class="text-center">
                        {% if ref.occurrence_count > 1 %}
                        <span style="color: var(--color-warning); font-weight: bold;">{{ ref.occurrence_count }}x</span>
                        {% else %}
                        <span style="color: var(--color-text-muted);">1x</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Removed Duplicates Table -->
{% if duplicates %}
<div class="card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
        <h3 style="margin: 0;">üóëÔ∏è Removed Duplicates ({{ stats.total_duplicates }})</h3>
        <form action="/export_dedup/duplicates" method="post" style="margin: 0;">
            {% for filename in filenames %}
            <input type="hidden" name="filenames" value="{{ filename }}">
            {% endfor %}
            <button type="submit" class="btn" style="background: var(--color-danger); color: white;">
                üì• Export as RIS
            </button>
        </form>
    </div>

    <div style="overflow-x: auto;">
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 50px;">#</th>
                    <th>Title</th>
                    <th style="width: 80px;">Year</th>
                    <th style="width: 150px;">Source File</th>
                    <th style="width: 250px;">Duplicate Across</th>
                </tr>
            </thead>
            <tbody>
                {% for ref in duplicates %}
                <tr style="background: rgba(var(--color-danger-rgb), 0.05);">
                    <td>{{ loop.index }}</td>
                    <td>
                        <strong>{{ ref.title or ref.ti or 'No Title' }}</strong>
                        {% set authors = ref.authors or ref.au %}
                        {% if authors is string %}
                        <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 0.25rem;">
                            {{ authors }}
                        </div>
                        {% elif authors is iterable %}
                        <div style="color: var(--color-text-muted); font-size: 14px; margin-top: 0.25rem;">
                            {{ authors[0] }}{% if authors|length > 1 %} et al.{% endif %}
                        </div>
                        {% endif %}
                    </td>
                    <td>{{ ref.year or ref.py or 'N/A' }}</td>
                    <td style="font-size: 13px;">
                        <span
                            style="padding: 4px 8px; background: rgba(var(--color-danger-rgb), 0.2); border-radius: 4px; display: inline-block;">
                            {{ ref.source_file }}
                        </span>
                    </td>
                    <td style="font-size: 13px;">
                        {% for source in ref.all_sources %}
                        <div
                            style="padding: 2px 6px; background: rgba(var(--color-text-muted-rgb), 0.1); border-radius: 4px; margin: 2px 0; display: inline-block;">
                            {{ source }}
                        </div>
                        {% endfor %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<div class="text-center mt-2">
    <a href="/" class="btn">‚Üê Back to Home</a>
</div>

{% endblock %}